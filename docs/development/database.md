# Database Guide

## Quick Reference

| Command | Purpose |
|---------|---------|
| `make db-verify` | Compare local vs production schema |
| `make db-sync` | Pull latest schema from production |
| `make db-studio` | Open Supabase Studio |
| `supabase db reset` | Reset local database |
| `supabase migration up` | Apply pending migrations |
| `supabase db diff -f name` | Create migration from changes |

## Daily Workflow

### Before Starting Work
```bash
make db-verify              # Check if schema is current
```

### If Schema is Out of Sync
```bash
make db-sync                # Pull production schema
supabase db reset           # Apply to local database
```

### Creating Schema Changes
```bash
# 1. Make changes in Supabase Studio
supabase studio

# 2. Generate migration
supabase db diff -f my_feature

# 3. Test locally
supabase db reset

# 4. Commit migration file
git add supabase/migrations/
```

## Environment Files

| File | Purpose | Created |
|------|---------|---------|
| `.env.local` | Local development | Auto-generated by `make up` |
| `.env.production` | Production testing | Manual from `.env.production.example` |

### Switch Environments
```bash
make up           # Local development (default)
make test-prod    # Test with production config
make env-local    # Switch back to local
```

## Reset to Production Schema

If local migrations are broken:

```bash
# 1. Stop Supabase
supabase stop

# 2. Backup and replace migrations
mv supabase/migrations supabase/migrations.old
mkdir supabase/migrations

# 3. Pull production as new baseline
supabase db pull

# 4. Start fresh
supabase start
```

## Migration Rules

**DO:**
- Keep migrations in version control
- Test locally before production
- Use descriptive migration names
- Create new migrations for changes

**DON'T:**
- Edit existing migration files
- Skip migrations and modify DB directly
- Commit `.env.production` with real credentials
- Copy production user data locally

## Troubleshooting

### Schema Out of Sync
```bash
make db-verify              # Check differences
make db-sync                # Pull latest
supabase db reset           # Apply
```

### Migration Failed
```bash
supabase migration list     # Check status
supabase logs               # View errors
supabase db reset           # Reset and retry
```

### Can't Connect to Production
```bash
# Verify credentials exist
cat .env.production | grep SUPABASE_URL

# Test connection
curl $SUPABASE_URL/rest/v1/
```

### Wrong Environment Running
```bash
make down                   # Stop everything
make env-check              # Verify state
make up                     # Start with local config
```
